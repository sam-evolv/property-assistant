From c8566c48039081a9448b04a07e87014a9dcb2416 Mon Sep 17 00:00:00 2001
From: Sam Donworth <sam@openhouse.ai>
Date: Wed, 21 Jan 2026 06:58:41 +0000
Subject: [PATCH 1/3] fix: Session persistence and login code flow issues

Issue 2 - Session Persistence:
- Remove automatic logout when visiting /purchaser page
- Redirect existing sessions to their home instead of logging out
- Extend ios_install_dismissed cookie from 1 day to 90 days

Issue 3 - Login Code vs QR Code Flow:
- Skip iOS install prompt if user has a token in URL (from login code entry)
- Skip iOS install prompt if user came from /purchaser login page
- Set ios_install_dismissed cookie when user enters login code manually
- This ensures users who type codes never see the 'download app' screen
---
 apps/unified-portal/app/install/page.tsx   |  3 ++-
 apps/unified-portal/app/purchaser/page.tsx | 13 +++++++++----
 apps/unified-portal/middleware.ts          | 19 ++++++++++++++++---
 3 files changed, 27 insertions(+), 8 deletions(-)

diff --git a/apps/unified-portal/app/install/page.tsx b/apps/unified-portal/app/install/page.tsx
index 545c437..ce11167 100644
--- a/apps/unified-portal/app/install/page.tsx
+++ b/apps/unified-portal/app/install/page.tsx
@@ -38,7 +38,8 @@ function InstallContent() {
   const appStoreUrl = 'https://apps.apple.com/app/openhouse-ai/id6504372916';
 
   const handleContinueWeb = () => {
-    document.cookie = 'ios_install_dismissed=1; path=/; max-age=86400; SameSite=Lax';
+    // Set cookie for 90 days (90 * 24 * 60 * 60 = 7776000 seconds)
+    document.cookie = 'ios_install_dismissed=1; path=/; max-age=7776000; SameSite=Lax';
     window.location.href = safeTarget;
   };
 
diff --git a/apps/unified-portal/app/purchaser/page.tsx b/apps/unified-portal/app/purchaser/page.tsx
index 0b269e3..6587389 100644
--- a/apps/unified-portal/app/purchaser/page.tsx
+++ b/apps/unified-portal/app/purchaser/page.tsx
@@ -15,12 +15,14 @@ export default function PurchaserLoginPage() {
 
   useEffect(() => {
     if (!isLoading) {
-      if (session) {
-        logout();
+      // If user already has a valid session, redirect them to their home instead of logging out
+      if (session && session.unitUid) {
+        router.push(`/homes/${session.unitUid}?token=${encodeURIComponent(session.token)}`);
+        return;
       }
       setSessionCleared(true);
     }
-  }, [isLoading, session, logout]);
+  }, [isLoading, session, router]);
 
   const handleSubmit = async (e: React.FormEvent) => {
     e.preventDefault();
@@ -43,7 +45,10 @@ export default function PurchaserLoginPage() {
       }
 
       login(data.session);
-      router.push(`/homes/${data.session.unitId}?token=${encodeURIComponent(data.session.token)}`);
+      // Set the iOS install dismissed cookie so user won't see app download prompt
+      // They entered a code manually, so they're intentionally using the web version
+      document.cookie = 'ios_install_dismissed=1; path=/; max-age=7776000; SameSite=Lax';
+      router.push(`/homes/${data.session.unitUid}?token=${encodeURIComponent(data.session.token)}`);
     } catch (err) {
       setError('Connection error. Please try again.');
       setIsSubmitting(false);
diff --git a/apps/unified-portal/middleware.ts b/apps/unified-portal/middleware.ts
index 2307a6e..ce14f24 100644
--- a/apps/unified-portal/middleware.ts
+++ b/apps/unified-portal/middleware.ts
@@ -111,10 +111,23 @@ export async function middleware(req: NextRequest) {
   if (pathname.startsWith('/homes/') && pathname !== '/homes/') {
     const userAgent = req.headers.get('user-agent') || '';
     const iosInstallDismissed = req.cookies.get('ios_install_dismissed')?.value;
-    
-    if (isIOSSafari(userAgent) && !iosInstallDismissed) {
+
+    // Check if user has a token in the URL (from login code entry or QR scan)
+    // If they have a token, they entered a login code - don't show install prompt
+    const hasToken = req.nextUrl.searchParams.has('token');
+
+    // Check referer to see if user came from /purchaser (manual code entry)
+    const referer = req.headers.get('referer') || '';
+    const cameFromPurchaserLogin = referer.includes('/purchaser');
+
+    // Only show iOS install prompt if:
+    // 1. User is on iOS Safari
+    // 2. They haven't dismissed it before
+    // 3. They DON'T have a token (meaning they didn't enter a login code)
+    // 4. They didn't come from the purchaser login page
+    if (isIOSSafari(userAgent) && !iosInstallDismissed && !hasToken && !cameFromPurchaserLogin) {
       const installUrl = new URL('/install', req.url);
-      installUrl.searchParams.set('target', pathname);
+      installUrl.searchParams.set('target', pathname + req.nextUrl.search);
       return NextResponse.redirect(installUrl);
     }
   }
-- 
2.34.1

