ROLE: You are the Replit Agent in the PropertyAssistant repo (apps/unified-portal). The multi-role routing logic was implemented, but in reality Sam’s multi-role account is still landing in the Enterprise Admin / Super Admin dashboard after login. Fix it so that any user who has developer access lands on the Developer Dashboard by default, including Sam’s multi-role account, with no exceptions.

GOAL (NON-NEGOTIABLE)
- After login, if roles[] contains "developer" (or "developer_admin"), the user MUST land on /developer (or /developer/overview).
- This must hold even if the user also has "admin" or "super_admin".
- Enterprise Admin and Super Admin routes must remain accessible for authorised roles, but must NOT override default landing.
- Fix must work in production once deployed.

ROOT CAUSES TO CHECK (DO NOT SKIP)
1) Login page redirect uses resolver, but middleware is overriding and redirecting to /admin or /super.
2) /api/auth/me is returning only a single role in production path, not roles[].
3) Session cookie / caching still uses legacy “role” field and ignores roles[].
4) There is still a “default redirect to /admin” somewhere (layout, auth gate, navbar click, or server action).
5) Role fetch is using .single() / findFirst() somewhere still.

PHASE 1: ADD HARD DIAGNOSTIC LOGGING (TEMPORARY, SERVER ONLY)
Implement server-side logs that clearly show:
- path requested
- user_id
- effective role
- roles[]
- chosen landing route
- whether middleware executed a redirect and to where
Do this in:
- apps/unified-portal/middleware.ts
- apps/unified-portal/lib/auth/resolvePostLoginRoute.ts
- apps/unified-portal/app/api/auth/me/route.ts

PHASE 2: MAKE LOGIN REDIRECT UNMISSABLE (SERVER-ENFORCED)
Implement a dedicated endpoint that computes and executes the redirect server-side.

1) Create: apps/unified-portal/app/api/auth/post-login/route.ts
- Read the current session server-side (supabase server client)
- Fetch ALL roles for user (no .single, no first row)
- Apply precedence:
  - if roles includes developer -> redirect to /developer
  - else if roles includes admin/tenant_admin -> redirect to /admin
  - else if roles includes super_admin -> redirect to /super
  - else redirect to /access-pending
- Respond with NextResponse.redirect(targetUrl)

2) Update login page to redirect to this endpoint after sign-in:
- After signInWithPassword succeeds:
  - router.replace("/api/auth/post-login") OR window.location.assign("/api/auth/post-login")
This guarantees the server decides the landing, not the client.

PHASE 3: FIX MIDDLEWARE OVERRIDE
In middleware.ts:
- Remove any logic that redirects super_admin/admin users to /super or /admin by default.
- Middleware must ONLY:
  - block access to restricted route groups
  - redirect AWAY from forbidden areas
It must never select a landing dashboard based on “highest role”.

Specifically:
- If user hits /admin but roles contains developer and NOT admin -> redirect to /developer
- If user hits /super but roles does NOT contain super_admin -> redirect to /developer (or /admin depending on roles)
- If user hits /developer but roles does NOT contain developer -> redirect to /admin if admin exists else /access-pending
- If user hits /login while authenticated -> redirect to /api/auth/post-login

PHASE 4: ENSURE DEVELOPER DASHBOARD ROUTE EXISTS + MATCHES TARGET
Confirm the correct landing route:
- If Developer Dashboard home is /developer/overview, use that consistently.
- If it is /developer, ensure /developer route exists and doesn’t redirect to /admin.

Search for any redirect in:
- app/developer/layout.tsx
- app/developer/page.tsx
- any guard components

PHASE 5: PRODUCTION VERIFICATION (MUST DO)
1) Add a temporary “/debug/auth” page (server rendered) that prints:
- user id
- effective role
- roles array
- current pathname
2) Test Sam’s account:
- Log in at /login
- Expected: /developer (Developer Dashboard)
- Visit /debug/auth and confirm roles includes developer + admin + super_admin, effective role is developer.
3) Remove /debug/auth after confirmation OR guard it behind super_admin only.

DELIVERABLES
- /api/auth/post-login server redirect endpoint
- login page uses it after sign-in
- middleware no longer overrides landing
- confirmation test using Sam’s account landing in Developer Dashboard

START NOW
Implement Phase 2 first (server redirect endpoint) then fix middleware overrides. This will make the landing deterministic.
